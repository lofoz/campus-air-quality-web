<!DOCTYPE html>
<html lang="zh-Hant-TW">
	<head>
		<!-- Required meta tags -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<meta http-equiv="X-UA-Compatible" content="ie=edge" />
		<!-- Bootstrap CSS -->
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
		 crossorigin="anonymous">
		<link href="https://fonts.googleapis.com/css?family=Noto+Sans+TC&display=swap" rel="stylesheet">
		<link rel="manifest" href="manifest.json">
		<link rel="stylesheet" type="text/css" href="./css/styles.css" />

		<!-- load map -->
		<script src="./js/googlemap.js" type="text/javascript" charset="utf-8"></script>
		<!-- local -->
		<!-- <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBqkHDM-JrgtN2FXNVhvLoHNm51SXMU4dc&callback=initMap"></script> -->
		<!-- online -->
		<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCEnj6nbVUv1jbacZTQIVbtcHvOlc7_fDM&callback=initMap"></script>

		<title>成大空汙資料平台</title>
		<link rel="icon" href="./img/192x192.png" type="image/x-icon" />
		<link rel="shortcut icon" href="./img/192x192.png" type="image/x-icon" />
	</head>
	<body>
		<!-- 標頭 -->
		<nav class="navbar navbar-expand-md navbar-dark sticky-top" style="background-color: #00cc99;">
			<div class="container">
				<a class="navbar-brand" onclick="javascript:location.href='index.html';" href="#" style="font-size: 24px;">
					<img class="mr-2" src="./img/ncku-logo-b.png" height="36" class="d-inline-block align-top" alt="">
					空汙資料平台
				</a>
				<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav"
				 aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse justify-content-end" id="navbarNav">
					<ul class="navbar-nav nav nav-pills">
						<li class="nav-item info">
							<a class="nav-link bg-transparent" data-toggle="pill" href="#" style="font-size: 18px;">簡介 <span class="sr-only">(current)</span></a>
						</li>
						<li class="nav-item map_page">
							<a class="nav-link bg-transparent active" data-toggle="pill" href="#map_page" style="font-size: 18px;">地圖</a>
						</li>
						<li class="nav-item data_analyze">
							<a class="nav-link bg-transparent" data-toggle="pill" onclick="javascript:location.href='data_analyze.html';"
							 href="#data_analyze" style="font-size: 18px;">數據分析</a>
						</li>
						<li class="nav-item sport_page">
							<a class="nav-link bg-transparent" data-toggle="pill" onclick="javascript:location.href='direction.html';" href="#direction"
							 style="font-size: 18px;">運動路徑</a>
						</li>
					</ul>
				</div>
			</div>
		</nav>


		<div class="container mt-4">
			<!-- 簡介 主頁面 -->
			<!-- <div id="info" class="tab-pane fade" role="tabpanel" aria-labelledby="info-tab">

				</div> -->
			<!-- 地圖 主頁面 -->
			<div id="map_page">
				<!-- 麵包屑 -->
				<div class="row">
					<div class="col-md-8 col-sm-6">
						<nav aria-label="breadcrumb">
							<ol class="breadcrumb pmalert">
								<li class="breadcrumb-item text-pmalert">Sensor Box 位置(0~7)：<br>生科系、MRI中心、勝一舍、學生會辦、建築系、資訊系、計網中心、儀器大樓</li>
							</ol>
						</nav>
					</div>
					<div class="col-md-4 col-sm-6">
						<nav aria-label="breadcrumb" onclick="setMap_my()">
							<ol class="breadcrumb pmlocate">
								<li class="breadcrumb-item text-pmlocate" id="my_pm">目前位置 最近Sensor：2<br>PM2.5：17.5 μg/m<sup>3</sup></li>
							</ol>
						</nav>
					</div>
				</div>

				<!-- 地圖和PM表格 -->
				<div class="row">
					<div class="col-lg-8">
						<div id="map" class="embed-responsive embed-responsive-16by9"></div>
					</div>
					<div class="col-lg-4 col-md-4 pmtable">
						<h3><b>Sensor</b></h3>
						<div class="table-responsive">
							<table class="table table-sm table-bordered table-hover">
								<thead>
									<tr>
										<th scope="col">位置</th>
										<th scope="col">PM2.5(μg/m<sup>3</sup>)</th>
										<th scope="col">溫度(°C)</th>
									</tr>
								</thead>
								<tbody>
									<tr class="table-muted" onclick="setMap(0)">
										<th scope="row">0</th>
										<td><span id="0pm"></span></td>
										<td><span id="0temp"></span></td>
									</tr>
									<tr class="table-primary" onclick="setMap(1)">
										<th scope="row">1</th>
										<td><span id="1pm"></span></td>
										<td><span id="1temp"></span></td>
									</tr>
									<tr class="table-success" onclick="setMap(2)">
										<th scope="row">2</th>
										<td><span id="2pm"></span></td>
										<td><span id="2temp"></span></td>
									</tr>
									<tr class="table-info" onclick="setMap(3)">
										<th scope="row">3</th>
										<td><span id="3pm"></span></td>
										<td><span id="3temp"></span></td>
									</tr>
									<tr class="table-warning" onclick="setMap(4)">
										<th scope="row">4</th>
										<td><span id="4pm"></span></td>
										<td><span id="4temp"></span></td>
									</tr>
									<tr class="table-danger" onclick="setMap(5)">
										<th scope="row">5</th>
										<td><span id="5pm"></span></td>
										<td><span id="5temp"></span></td>
									</tr>
									<tr class="table-secondary" onclick="setMap(6)">
										<th scope="row">6</th>
										<td><span id="6pm"></span></td>
										<td><span id="6temp"></span></td>
									</tr>
									<tr class="table-light" onclick="setMap(7)">
										<th scope="row">7</th>
										<td><span id="7pm"></span></td>
										<td><span id="7temp"></span></td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
					<!-- 色溫圖 -->
					<div class="col-md-8 mt-2">
						<h3 class="pl-4"><b>色溫圖</b></h3>
						<img class="d-block w-100" src="https://nckuairpollution.csie.ncku.edu.tw:6800/campus/picture">
					</div>
				</div>
			</div>
			<!-- 運動路徑 主頁面 -->
			<!-- <div id="sport_page" class="tab-pane fade" role="tabpanel" aria-labelledby="sport_page-tab">

				</div> -->
		</div>

		<!-- Optional JavaScript -->
		<!-- jQuery first, then Popper.js, then Bootstrap JS -->
		<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
		 crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
		 crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
		 crossorigin="anonymous"></script>
		<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
		<script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-database.js"></script>
		<script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-messaging.js"></script>
		<script>
			// Your web app's Firebase configuration
			var firebaseConfig = {
				apiKey: "AIzaSyBBnECtCvqhG3wmZpORfS3VJZlgjK1KLaU",
				authDomain: "test-6d390.firebaseapp.com",
				databaseURL: "https://test-6d390.firebaseio.com",
				projectId: "test-6d390",
				storageBucket: "test-6d390.appspot.com",
				messagingSenderId: "1072871991195",
				appId: "1:1072871991195:web:0c4beef2a181536b15633e",
				measurementId: "G-QSTSCG37TE"
			};
			// Initialize Firebase
			firebase.initializeApp(firebaseConfig);
			var database = firebase.database();
			var messaging = firebase.messaging();
			const tokenDivId = 'token_div';
			const permissionDivId = 'permission_div';
			messaging.usePublicVapidKey(
				'BOcVtHmZ6xJMkhgKmtgmsGcr8zZVOfQJEfiynuGlVGqAwFFERoFFoFZFAnI7j3o5fFHhnahnOVdAJifO_EnBFaQ');
			window.addEventListener('load', function() {
				if ('serviceWorker' in navigator) {
					navigator.serviceWorker.register('sw.js')
						.then(reg => {
							// firebase methods，用同一支sw.js
							messaging.useServiceWorker(reg);

							messaging.onTokenRefresh(() => {
								messaging.getToken().then((refreshedToken) => {
									console.log('Token refreshed.');
									// Indicate that the new Instance ID token has not yet been sent to the
									// app server.
									setTokenSentToServer(false);
									// Send Instance ID token to app server.
									sendTokenToServer(refreshedToken);
									// [START_EXCLUDE]
									// Display new Instance ID token and clear UI of all previous messages.
									resetUI();
									// [END_EXCLUDE]
								}).catch((err) => {
									console.log('Unable to retrieve refreshed token ', err);
								});
							});
							// [END refresh_token]

							// [START receive_message]
							// Handle incoming messages. Called when:
							// - a message is received while the app has focus
							// - the user clicks on an app notification created by a service worker
							//   `messaging.setBackgroundMessageHandler` handler.

							messaging.onMessage((payload) => {
								console.log('Message received. ', payload);
								var data = payload.notification;
								var title = data.title;
								var options = {
									body: data.body
								};
								var url = data.click_action;
								var notification = new Notification(title, options);

								// 點擊推播後要連去哪
								notification.addEventListener('click', function(e) {
									e.preventDefault();
									location.href = url;
								});
								// [START_EXCLUDE]
								// Update the UI to include the received message.
								// [END_EXCLUDE]
							});
							// [END receive_message]

							function resetUI() {
								// [START get_token]
								// Get Instance ID token. Initially this makes a network call, once retrieved
								// subsequent calls to getToken will return from cache.
								messaging.getToken().then((currentToken) => {
									if (currentToken) {
										console.log(currentToken);
										sendTokenToServer(currentToken);
									} else {
										// Show permission request.
										console.log('No Instance ID token available. Request permission to generate one.');
										// Show permission UI.
										setTokenSentToServer(false);
									}
								}).catch((err) => {
									console.log('An error occurred while retrieving token. ', err);
									setTokenSentToServer(false);
								});
								// [END get_token]
							}

							// Send the Instance ID token your application server, so that it can:
							// - send messages back to this app
							// - subscribe/unsubscribe the token from topics
							function sendTokenToServer(currentToken) {
								if (!isTokenSentToServer()) {
									console.log('Sending token to server...');
									// TODO(developer): Send the current token to your server.
									var id = currentToken.split(':')[0];
									firebase.database().ref('pushUsers/' + id).set({
										'token': currentToken
									});
									setTokenSentToServer(true);
								} else {
									console.log('Token already sent to server so won\'t send it again ' +
										'unless it changes');
								}

							}

							function isTokenSentToServer() {
								return window.localStorage.getItem('sentToServer') === '1';
							}

							function setTokenSentToServer(sent) {
								window.localStorage.setItem('sentToServer', sent ? '1' : '0');
							}

							messaging.requestPermission().then(function() {
								resetUI();
							}).catch(function(err) {
								console.log('使用者未允許通知', err);
							});
						})
						.catch(err => console.log('Error!', err));
				}
			});
		</script>
		<script src="js/loaddata.js" type="text/javascript" charset="utf-8"></script>
	</body>
</html>
